"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

var _fs = require("fs");

var _path = require("path");

var _os = require("os");

var _chalk = _interopRequireDefault(require("chalk"));

var _query = _interopRequireDefault(require("./query"));

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

/* eslint-disable max-len */
const TOKEN_FILENAME = '.redocly-config.json';

class RedoclyClient {
  constructor() {
    this.loadToken();
  }

  hasToken() {
    return !!this.accessToken;
  }

  loadToken() {
    if (process.env.REDOCLY_AUTHORIZATION) {
      this.accessToken = process.env.REDOCLY_AUTHORIZATION;
      return;
    }

    const credentialsPath = (0, _path.resolve)((0, _os.homedir)(), TOKEN_FILENAME);

    if ((0, _fs.existsSync)(credentialsPath)) {
      const credentials = JSON.parse((0, _fs.readFileSync)(credentialsPath, 'utf-8'));
      this.accessToken = credentials && credentials.token;
    }
  }

  async verifyToken(accessToken) {
    if (!accessToken) return false;
    const authDetails = await RedoclyClient.authorize(accessToken);
    if (!authDetails) return false;
    return true;
  }

  async getAuthorizationHeader() {
    // print this only if there is token but invalid
    if (this.accessToken && !(await this.verifyToken(this.accessToken))) {
      process.stdout.write(`${_chalk.default.yellow('Warning:')} invalid Redoc.ly access token. Use "npx @redocly/openapi-cli registry:login" to provide your access token\n`);
      return null;
    }

    return this.accessToken;
  }

  async login(accessToken) {
    const credentialsPath = (0, _path.resolve)((0, _os.homedir)(), TOKEN_FILENAME);
    process.stdout.write(_chalk.default.grey('\n  Logging in...\n'));
    const authorized = await this.verifyToken(accessToken);

    if (!authorized) {
      process.stdout.write(_chalk.default.red('Authorization failed. Please check if you entered a valid token.\n'));
      process.exit(1);
    }

    this.accessToken = accessToken;
    const credentials = {
      token: accessToken
    };
    (0, _fs.writeFileSync)(credentialsPath, JSON.stringify(credentials, null, 2));
    process.stdout.write(_chalk.default.green('  Authorization confirmed. ‚úÖ\n\n'));
  }

  logout() {
    const credentialsPath = (0, _path.resolve)((0, _os.homedir)(), TOKEN_FILENAME);

    if ((0, _fs.existsSync)(credentialsPath)) {
      (0, _fs.unlinkSync)(credentialsPath);
    }

    process.stdout.write('Logged out from the Redoc.ly account. ‚úã\n');
  }

  async query(queryString, parameters = {}, headers = {}) {
    return (0, _query.default)(queryString, parameters, {
      Authorization: this.accessToken,
      ...headers
    });
  }

  static async authorize(accessToken, verbose = false) {
    try {
      const result = await (0, _query.default)(`
      {
        definitions {
          id
        }
      }
      `, {}, {
        Authorization: accessToken
      });
      return result;
    } catch (e) {
      if (verbose) process.stderr.write(e);
      return null;
    }
  }

  async updateDependencies(dependencies) {
    const r = await this.query(`
    mutation UpdateBranchDependenciesFromURLs(
      $urls: [String!]!
      $definitionId: Int!
      $versionId: Int!
      $branchId: Int!
    ) {
      updateBranchDependenciesFromURLs(
        definitionId: $definitionId
        versionId: $versionId
        branchId: $branchId
        urls: $urls
      ) {
        branchName
      }
    }
    `, {
      urls: dependencies || [],
      definitionId: parseInt(process.env.DEFINITION, 10),
      versionId: parseInt(process.env.VERSION, 10),
      branchId: parseInt(process.env.BRANCH, 10)
    });
    return r;
  }

  static isRegistryURL(link) {
    const domain = process.env.REDOCLY_DOMAIN || 'redoc.ly';
    if (!link.startsWith(`https://api.${domain}/registry/`)) return false;
    const registryPath = link.replace(`https://api.${domain}/registry/`, '');
    const pathParts = registryPath.split('/'); // we can be sure, that there is job UUID present
    // (org, definition, version, bundle, branch, job, "openapi.yaml" ü§¶‚Äç‚ôÇÔ∏è)
    // so skip this link.

    if (pathParts.length === 7) return false;
    return true;
  }

}

exports.default = RedoclyClient;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9yZWRvY2x5L2luZGV4LmpzIl0sIm5hbWVzIjpbIlRPS0VOX0ZJTEVOQU1FIiwiUmVkb2NseUNsaWVudCIsImNvbnN0cnVjdG9yIiwibG9hZFRva2VuIiwiaGFzVG9rZW4iLCJhY2Nlc3NUb2tlbiIsInByb2Nlc3MiLCJlbnYiLCJSRURPQ0xZX0FVVEhPUklaQVRJT04iLCJjcmVkZW50aWFsc1BhdGgiLCJjcmVkZW50aWFscyIsIkpTT04iLCJwYXJzZSIsInRva2VuIiwidmVyaWZ5VG9rZW4iLCJhdXRoRGV0YWlscyIsImF1dGhvcml6ZSIsImdldEF1dGhvcml6YXRpb25IZWFkZXIiLCJzdGRvdXQiLCJ3cml0ZSIsImNoYWxrIiwieWVsbG93IiwibG9naW4iLCJncmV5IiwiYXV0aG9yaXplZCIsInJlZCIsImV4aXQiLCJzdHJpbmdpZnkiLCJncmVlbiIsImxvZ291dCIsInF1ZXJ5IiwicXVlcnlTdHJpbmciLCJwYXJhbWV0ZXJzIiwiaGVhZGVycyIsIkF1dGhvcml6YXRpb24iLCJ2ZXJib3NlIiwicmVzdWx0IiwiZSIsInN0ZGVyciIsInVwZGF0ZURlcGVuZGVuY2llcyIsImRlcGVuZGVuY2llcyIsInIiLCJ1cmxzIiwiZGVmaW5pdGlvbklkIiwicGFyc2VJbnQiLCJERUZJTklUSU9OIiwidmVyc2lvbklkIiwiVkVSU0lPTiIsImJyYW5jaElkIiwiQlJBTkNIIiwiaXNSZWdpc3RyeVVSTCIsImxpbmsiLCJkb21haW4iLCJSRURPQ0xZX0RPTUFJTiIsInN0YXJ0c1dpdGgiLCJyZWdpc3RyeVBhdGgiLCJyZXBsYWNlIiwicGF0aFBhcnRzIiwic3BsaXQiLCJsZW5ndGgiXSwibWFwcGluZ3MiOiI7Ozs7Ozs7QUFDQTs7QUFHQTs7QUFDQTs7QUFDQTs7QUFFQTs7OztBQVJBO0FBVUEsTUFBTUEsY0FBYyxHQUFHLHNCQUF2Qjs7QUFFZSxNQUFNQyxhQUFOLENBQW9CO0FBQ2pDQyxFQUFBQSxXQUFXLEdBQUc7QUFDWixTQUFLQyxTQUFMO0FBQ0Q7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SSxDQUFDRixJQUFJLENBQUNHLFVBQUwsQ0FBaUIsZUFBY0YsTUFBTyxZQUF0QyxDQUFMLEVBQXlELE9BQU8sS0FBUDtBQUN6RCxVQUFNRyxZQUFZLEdBQUdKLElBQUksQ0FBQ0ssT0FBTCxDQUFjLGVBQWNKLE1BQU8sWUFBbkMsRUFBZ0QsRUFBaEQsQ0FBckI7QUFFQSxVQUFNSyxTQUFTLEdBQUdGLFlBQVksQ0FBQ0csS0FBYixDQUFtQixHQUFuQixDQUFsQixDQUx5QixDQU96QjtBQUNBO0FBQ0E7O0FBQ0EsUUFBSUQsU0FBUyxDQUFDRSxNQUFWLEtBQXFCLENBQXpCLEVBQTRCLE9BQU8sS0FBUDtBQUU1QixXQUFPLElBQVA7QUFDRDs7QUF4SWdDIiwic291cmNlc0NvbnRlbnQiOlsiLyogZXNsaW50LWRpc2FibGUgbWF4LWxlbiAqL1xuaW1wb3J0IHtcbiAgZXhpc3RzU3luYywgcmVhZEZpbGVTeW5jLCB3cml0ZUZpbGVTeW5jLCB1bmxpbmtTeW5jLFxufSBmcm9tICdmcyc7XG5pbXBvcnQgeyByZXNvbHZlIH0gZnJvbSAncGF0aCc7XG5pbXBvcnQgeyBob21lZGlyIH0gZnJvbSAnb3MnO1xuaW1wb3J0IGNoYWxrIGZyb20gJ2NoYWxrJztcblxuaW1wb3J0IHF1ZXJ5IGZyb20gJy4vcXVlcnknO1xuXG5jb25zdCBUT0tFTl9GSUxFTkFNRSA9ICcucmVkb2NseS1jb25maWcuanNvbic7XG5cbmV4cG9ydCBkZWZhdWx0IGNsYXNzIFJlZG9jbHlDbGllbnQge1xuICBjb25zdHJ1Y3RvcigpIHtcbiAgICB0aGlzLmxvYWRUb2tlbigpO1xuICB9XG5cbiAgaGFzVG9rZW4oKSB7XG4gICAgcmV0dXJuICEhdGhpcy5hY2Nlc3NUb2tlbjtcbiAgfVxuXG4gIGxvYWRUb2tlbigpIHtcbiAgICBpZiAocHJvY2Vzcy5lbnYuUkVET0NMWV9BVVRIT1JJWkFUSU9OKSB7XG4gICAgICB0aGlzLmFjY2Vzc1Rva2VuID0gcHJvY2Vzcy5lbnYuUkVET0NMWV9BVVRIT1JJWkFUSU9OO1xuICAgICAgcmV0dXJuO1xuICAgIH1cblxuICAgIGNvbnN0IGNyZWRlbnRpYWxzUGF0aCA9IHJlc29sdmUoaG9tZWRpcigpLCBUT0tFTl9GSUxFTkFNRSk7XG4gICAgaWYgKGV4aXN0c1N5bmMoY3JlZGVudGlhbHNQYXRoKSkge1xuICAgICAgY29uc3QgY3JlZGVudGlhbHMgPSBKU09OLnBhcnNlKHJlYWRGaWxlU3luYyhjcmVkZW50aWFsc1BhdGgsICd1dGYtOCcpKTtcbiAgICAgIHRoaXMuYWNjZXNzVG9rZW4gPSBjcmVkZW50aWFscyAmJiBjcmVkZW50aWFscy50b2tlbjtcbiAgICB9XG4gIH1cblxuICBhc3luYyB2ZXJpZnlUb2tlbihhY2Nlc3NUb2tlbikge1xuICAgIGlmICghYWNjZXNzVG9rZW4pIHJldHVybiBmYWxzZTtcbiAgICBjb25zdCBhdXRoRGV0YWlscyA9IGF3YWl0IFJlZG9jbHlDbGllbnQuYXV0aG9yaXplKGFjY2Vzc1Rva2VuKTtcbiAgICBpZiAoIWF1dGhEZXRhaWxzKSByZXR1cm4gZmFsc2U7XG4gICAgcmV0dXJuIHRydWU7XG4gIH1cblxuICBhc3luYyBnZXRBdXRob3JpemF0aW9uSGVhZGVyKCkge1xuICAgIC8vIHByaW50IHRoaXMgb25seSBpZiB0aGVyZSBpcyB0b2tlbiBidXQgaW52YWxpZFxuICAgIGlmICh0aGlzLmFjY2Vzc1Rva2VuICYmICEoYXdhaXQgdGhpcy52ZXJpZnlUb2tlbih0aGlzLmFjY2Vzc1Rva2VuKSkpIHtcbiAgICAgIHByb2Nlc3Muc3Rkb3V0LndyaXRlKFxuICAgICAgICBgJHtjaGFsay55ZWxsb3coJ1dhcm5pbmc6Jyl9IGludmFsaWQgUmVkb2MubHkgYWNjZXNzIHRva2VuLiBVc2UgXCJucHggQHJlZG9jbHkvb3BlbmFwaS1jbGkgcmVnaXN0cnk6bG9naW5cIiB0byBwcm92aWRlIHlvdXIgYWNjZXNzIHRva2VuXFxuYCxcbiAgICAgICk7XG4gICAgICByZXR1cm4gbnVsbDtcbiAgICB9XG4gICAgcmV0dXJuIHRoaXMuYWNjZXNzVG9rZW47XG4gIH1cblxuICBhc3luYyBsb2dpbihhY2Nlc3NUb2tlbikge1xuICAgIGNvbnN0IGNyZWRlbnRpYWxzUGF0aCA9IHJlc29sdmUoaG9tZWRpcigpLCBUT0tFTl9GSUxFTkFNRSk7XG4gICAgcHJvY2Vzcy5zdGRvdXQud3JpdGUoY2hhbGsuZ3JleSgnXFxuICBMb2dnaW5nIGluLi4uXFxuJykpO1xuXG4gICAgY29uc3QgYXV0aG9yaXplZCA9IGF3YWl0IHRoaXMudmVyaWZ5VG9rZW4oYWNjZXNzVG9rZW4pO1xuXG4gICAgaWYgKCFhdXRob3JpemVkKSB7XG4gICAgICBwcm9jZXNzLnN0ZG91dC53cml0ZShjaGFsay5yZWQoJ0F1dGhvcml6YXRpb24gZmFpbGVkLiBQbGVhc2UgY2hlY2sgaWYgeW91IGVudGVyZWQgYSB2YWxpZCB0b2tlbi5cXG4nKSk7XG4gICAgICBwcm9jZXNzLmV4aXQoMSk7XG4gICAgfVxuXG4gICAgdGhpcy5hY2Nlc3NUb2tlbiA9IGFjY2Vzc1Rva2VuO1xuICAgIGNvbnN0IGNyZWRlbnRpYWxzID0ge1xuICAgICAgdG9rZW46IGFjY2Vzc1Rva2VuLFxuICAgIH07XG5cbiAgICB3cml0ZUZpbGVTeW5jKGNyZWRlbnRpYWxzUGF0aCwgSlNPTi5zdHJpbmdpZnkoY3JlZGVudGlhbHMsIG51bGwsIDIpKTtcbiAgICBwcm9jZXNzLnN0ZG91dC53cml0ZShjaGFsay5ncmVlbignICBBdXRob3JpemF0aW9uIGNvbmZpcm1lZC4g4pyFXFxuXFxuJykpO1xuICB9XG5cbiAgbG9nb3V0KCkge1xuICAgIGNvbnN0IGNyZWRlbnRpYWxzUGF0aCA9IHJlc29sdmUoaG9tZWRpcigpLCBUT0tFTl9GSUxFTkFNRSk7XG4gICAgaWYgKGV4aXN0c1N5bmMoY3JlZGVudGlhbHNQYXRoKSkge1xuICAgICAgdW5saW5rU3luYyhjcmVkZW50aWFsc1BhdGgpO1xuICAgIH1cbiAgICBwcm9jZXNzLnN0ZG91dC53cml0ZSgnTG9nZ2VkIG91dCBmcm9tIHRoZSBSZWRvYy5seSBhY2NvdW50LiDinItcXG4nKTtcbiAgfVxuXG4gIGFzeW5jIHF1ZXJ5KHF1ZXJ5U3RyaW5nLCBwYXJhbWV0ZXJzID0ge30sIGhlYWRlcnMgPSB7fSkge1xuICAgIHJldHVybiBxdWVyeShxdWVyeVN0cmluZywgcGFyYW1ldGVycyxcbiAgICAgIHtcbiAgICAgICAgQXV0aG9yaXphdGlvbjogdGhpcy5hY2Nlc3NUb2tlbixcbiAgICAgICAgLi4uaGVhZGVycyxcbiAgICAgIH0pO1xuICB9XG5cbiAgc3RhdGljIGFzeW5jIGF1dGhvcml6ZShhY2Nlc3NUb2tlbiwgdmVyYm9zZSA9IGZhbHNlKSB7XG4gICAgdHJ5IHtcbiAgICAgIGNvbnN0IHJlc3VsdCA9IGF3YWl0IHF1ZXJ5KGBcbiAgICAgIHtcbiAgICAgICAgZGVmaW5pdGlvbnMge1xuICAgICAgICAgIGlkXG4gICAgICAgIH1cbiAgICAgIH1cbiAgICAgIGAsXG4gICAgICB7fSxcbiAgICAgIHtcbiAgICAgICAgQXV0aG9yaXphdGlvbjogYWNjZXNzVG9rZW4sXG4gICAgICB9KTtcbiAgICAgIHJldHVybiByZXN1bHQ7XG4gICAgfSBjYXRjaCAoZSkge1xuICAgICAgaWYgKHZlcmJvc2UpIHByb2Nlc3Muc3RkZXJyLndyaXRlKGUpO1xuICAgICAgcmV0dXJuIG51bGw7XG4gICAgfVxuICB9XG5cbiAgYXN5bmMgdXBkYXRlRGVwZW5kZW5jaWVzKGRlcGVuZGVuY2llcykge1xuICAgIGNvbnN0IHIgPSBhd2FpdCB0aGlzLnF1ZXJ5KGBcbiAgICBtdXRhdGlvbiBVcGRhdGVCcmFuY2hEZXBlbmRlbmNpZXNGcm9tVVJMcyhcbiAgICAgICR1cmxzOiBbU3RyaW5nIV0hXG4gICAgICAkZGVmaW5pdGlvbklkOiBJbnQhXG4gICAgICAkdmVyc2lvbklkOiBJbnQhXG4gICAgICAkYnJhbmNoSWQ6IEludCFcbiAgICApIHtcbiAgICAgIHVwZGF0ZUJyYW5jaERlcGVuZGVuY2llc0Zyb21VUkxzKFxuICAgICAgICBkZWZpbml0aW9uSWQ6ICRkZWZpbml0aW9uSWRcbiAgICAgICAgdmVyc2lvbklkOiAkdmVyc2lvbklkXG4gICAgICAgIGJyYW5jaElkOiAkYnJhbmNoSWRcbiAgICAgICAgdXJsczogJHVybHNcbiAgICAgICkge1xuICAgICAgICBicmFuY2hOYW1lXG4gICAgICB9XG4gICAgfVxuICAgIGAsXG4gICAge1xuICAgICAgdXJsczogZGVwZW5kZW5jaWVzIHx8IFtdLFxuICAgICAgZGVmaW5pdGlvbklkOiBwYXJzZUludChwcm9jZXNzLmVudi5ERUZJTklUSU9OLCAxMCksXG4gICAgICB2ZXJzaW9uSWQ6IHBhcnNlSW50KHByb2Nlc3MuZW52LlZFUlNJT04sIDEwKSxcbiAgICAgIGJyYW5jaElkOiBwYXJzZUludChwcm9jZXNzLmVudi5CUkFOQ0gsIDEwKSxcbiAgICB9KTtcbiAgICByZXR1cm4gcjtcbiAgfVxuXG4gIHN0YXRpYyBpc1JlZ2lzdHJ5VVJMKGxpbmspIHtcbiAgICBjb25zdCBkb21haW4gPSBwcm9jZXNzLmVudi5SRURPQ0xZX0RPTUFJTiB8fCAncmVkb2MubHknO1xuICAgIGlmICghbGluay5zdGFydHNXaXRoKGBodHRwczovL2FwaS4ke2RvbWFpbn0vcmVnaXN0cnkvYCkpIHJldHVybiBmYWxzZTtcbiAgICBjb25zdCByZWdpc3RyeVBhdGggPSBsaW5rLnJlcGxhY2UoYGh0dHBzOi8vYXBpLiR7ZG9tYWlufS9yZWdpc3RyeS9gLCAnJyk7XG5cbiAgICBjb25zdCBwYXRoUGFydHMgPSByZWdpc3RyeVBhdGguc3BsaXQoJy8nKTtcblxuICAgIC8vIHdlIGNhbiBiZSBzdXJlLCB0aGF0IHRoZXJlIGlzIGpvYiBVVUlEIHByZXNlbnRcbiAgICAvLyAob3JnLCBkZWZpbml0aW9uLCB2ZXJzaW9uLCBidW5kbGUsIGJyYW5jaCwgam9iLCBcIm9wZW5hcGkueWFtbFwiIPCfpKbigI3imYLvuI8pXG4gICAgLy8gc28gc2tpcCB0aGlzIGxpbmsuXG4gICAgaWYgKHBhdGhQYXJ0cy5sZW5ndGggPT09IDcpIHJldHVybiBmYWxzZTtcblxuICAgIHJldHVybiB0cnVlO1xuICB9XG59XG4iXX0=